<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Decision | Club T Poker</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-900:#0b0b10; --bg-800:#111118;
      --text-100:#f4f7ff; --text-300:#b9bfcc;
      --neon-purple:#8a7cfb; --neon-blue:#39c8ff;
      --card-bg:#151823; --card-border:#24283a;
      --ok:#39c8ff; --warn:#8a7cfb;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; min-height:100vh;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background: linear-gradient(180deg, var(--bg-900), var(--bg-800));
      color:var(--text-100);
      font-family:"Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: clamp(16px, 4vw, 32px);
      gap: 18px;
    }
    header{ position:absolute; top:16px; left:16px }
    .logo{ display:flex; align-items:center; gap:.6rem; font-weight:800; letter-spacing:.06em; text-transform:uppercase }
    .logo .club{ display:grid; place-items:center; width:28px; height:28px; border-radius:8px;
      background: radial-gradient(120% 140% at 70% 10%, var(--neon-purple), #5b4bff 65%, #2b2b60 100%);
      color:#0b0b10; font-size:18px; box-shadow:0 0 14px rgba(138,124,251,.55), inset 0 2px 8px rgba(255,255,255,.3) }

    h1{ font-size:clamp(26px,6vw,44px); margin:10px 0 6px; text-align:center; text-shadow:0 0 20px rgba(138,124,251,.35) }
    .sub{ color:var(--text-300); margin:0 0 14px; text-align:center }

    .grid{
      width:100%; max-width:1000px;
      display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
      gap:14px; margin-top:6px;
    }
    .card{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:14px; padding:16px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05), 0 10px 22px rgba(0,0,0,.25);
    }
    .card h3{ margin:0 0 8px; font-size:18px }
    .card ul{ margin:8px 0 0 18px; padding:0; color:var(--text-300); }
    .badge{
      display:inline-block; padding:.45rem .8rem; border-radius:12px; font-weight:800; letter-spacing:.04em; text-transform:uppercase;
      color:#0b0b10; background:var(--neon-purple); border:1px solid rgba(138,124,251,.35);
      box-shadow: 0 10px 22px rgba(90,80,255,.25);
    }
    .badge.call{ background: var(--ok); }
    .badge.fold{ background: #2a2f3d; color:#f4f7ff; border-color:#3a4050; box-shadow:none }

    .verdict{
      width:100%; max-width:1000px; margin-top:8px;
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:14px; padding:18px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05), 0 10px 22px rgba(0,0,0,.25);
    }
    .verdict .title{ display:flex; align-items:center; gap:10px; margin-bottom:8px }
    .verdict .rationale{ color:var(--text-300) }

    .kv{ color:var(--text-300); font-size:13px; margin: 6px 0; text-align:center }
    .kv strong{ color:var(--text-100) }

    .actions{ margin-top:16px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap }
    .btn, .btn:visited{
      display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      padding:.9rem 1.1rem; border-radius:12px; text-decoration:none; font-weight:800;
      background: var(--neon-purple); color:#0b0b10; border:1px solid rgba(138,124,251,.35);
      transition: transform .15s ease, background .15s ease; cursor:pointer;
    }
    .btn:hover{ transform:scale(1.03); background: var(--neon-blue) }
    .btn.secondary{ background: transparent; color: var(--neon-purple); border-color: rgba(138,124,251,.4) }
    .btn.secondary:hover{ color: var(--neon-blue); border-color: rgba(57,200,255,.5) }

    .error{
      border:1px solid rgba(255,80,80,.35); background:rgba(255,80,80,.08);
      color:#ffdede; padding:12px 14px; border-radius:10px; margin:8px 0; display:none;
      max-width:1000px; width:100%;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo" aria-label="Club T Poker">
      <span class="club" aria-hidden="true">♣</span>
      <span>Club&nbsp;T&nbsp;Poker</span>
    </div>
  </header>

  <main style="width:100%; max-width:1080px;">
    <h1>Your pre-flop decision (AI)</h1>
    <p class="sub" id="ctx">Loading…</p>

    <div id="error" class="error"></div>

    <!-- Three reasoning boxes -->
    <section class="grid">
      <div class="card">
        <div class="badge fold">When to Fold</div>
        <ul id="when_fold"></ul>
      </div>
      <div class="card">
        <div class="badge call">When to Call</div>
        <ul id="when_call"></ul>
      </div>
      <div class="card">
        <div class="badge">When to Raise</div>
        <ul id="when_raise"></ul>
      </div>
    </section>

    <!-- Overall verdict -->
    <section class="verdict" id="verdict" style="display:none;">
      <div class="title">
        <span id="decisionBadge" class="badge">Decision</span>
        <strong id="decisionText"></strong>
      </div>
      <div class="rationale" id="rationale">—</div>
      <div class="kv" id="flags" style="display:none;"></div>

      <div class="actions">
        <a id="back" class="btn secondary" href="#">⟵ Back</a>
        <a class="btn secondary" href="/">⟲ Restart</a>
      </div>
    </section>
  </main>

  <script>
    // Read inputs from URL
    const q = new URLSearchParams(location.search);
    const params = {
      players: q.get('players'),
      position: q.get('position'),
      hand: q.get('hand'),
      situation: q.get('situation'),
      limpers: q.get('limpers'),
      openSize: q.get('openSize'),
      openPos: q.get('openPos'),
      openCallers: q.get('openCallers'),
      threeBetSize: q.get('threeBetSize'),
      threeBetIP: q.get('threeBetIP'),
      threeBetCallers: q.get('threeBetCallers'),
      // optional opponent profile defaults
      style: q.get('style') || 'standard',
      bluffing: q.get('bluffing') || 'normal'
    };

    const ctx = document.getElementById('ctx');
    const err = document.getElementById('error');

    function ctxText(p){
      return `Table: ${p.players} • Position: ${p.position} • Hand: ${(p.hand || '').toUpperCase()} • Situation: ${p.situation}`;
    }

    async function run(){
      // Basic check
      if(!params.players || !params.position || !params.hand || !params.situation){
        err.style.display = 'block';
        err.textContent = 'Missing info. Please go back and complete previous steps.';
        ctx.textContent = 'Error';
        return;
      }

      // Back link back to action.html (preserve params)
      const back = document.getElementById('back');
      const backURL = new URL('/action.html', location.origin);
      Object.entries(params).forEach(([k,v]) => { if(v !== null && v !== undefined) backURL.searchParams.set(k, v); });
      back.href = backURL.toString();

      ctx.textContent = ctxText(params);

      try {
        // Call your serverless API (uses your Vercel env key)
        const apiURL = new URL('/api/decide', location.origin);
        Object.entries(params).forEach(([k,v]) => { if(v) apiURL.searchParams.set(k, v); });

        const resp = await fetch(apiURL.toString(), { method: 'GET' });
        if(!resp.ok){
          const txt = await resp.text();
          throw new Error(`API error: ${txt}`);
        }
        const data = await resp.json();

        // Fill three boxes
        const fill = (id, arr) => {
          const ul = document.getElementById(id);
          ul.innerHTML = '';
          (arr || []).forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            ul.appendChild(li);
          });
          if((arr || []).length === 0){
            const li = document.createElement('li');
            li.textContent = '—';
            ul.appendChild(li);
          }
        };
        fill('when_fold', data.when_fold);
        fill('when_call', data.when_call);
        fill('when_raise', data.when_raise);

        // Verdict box
        const verdict = document.getElementById('verdict');
        const badge = document.getElementById('decisionBadge');
        const decisionText = document.getElementById('decisionText');
        const rationale = document.getElementById('rationale');
        const flags = document.getElementById('flags');

        decisionText.textContent = data.decision || '—';
        rationale.textContent = data.rationale || '';
        badge.className = 'badge';
        if(/fold/i.test(data.decision)) badge.classList.add('fold');
        else if(/call/i.test(data.decision)) badge.classList.add('call');

        if(Array.isArray(data.risk_flags) && data.risk_flags.length){
          flags.style.display = '';
          flags.innerHTML = `Risk flags: <strong>${data.risk_flags.join(' • ')}</strong>`;
        } else {
          flags.style.display = 'none';
        }

        verdict.style.display = '';

      } catch (e){
        err.style.display = 'block';
        err.textContent = `Could not fetch AI decision. ${e.message}`;
      }
    }

    run();
  </script>
</body>
</html>
